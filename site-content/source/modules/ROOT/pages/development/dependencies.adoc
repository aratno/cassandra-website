:page-layout: basic

== Dependency Management

New dependencies should not be included without community consensus first being
obtained via a `[DISCUSS]` thread on the dev@cassandra.apache.org mailing list.

As Cassandra is an Apache product, all included libraries must follow
Apache's https://www.apache.org/legal/resolved.html[software license
requirements].

=== Dependency management in Cassandra 4.2 and onwards

In Cassandra 4.2 and onwards dependencies are managed in Maven POM templates
in `.build/\*-template.xml`. These templates are processed into valid Maven POMs
with the `ant write-poms` task and copied to `build/\*.pom`.

The following POMs from a pre-4.2 `build.xml` have been migrated to templates:

* `parent-pom`
  - is now  `.build/parent-pom-template.xml`
  - contains all dependencies with the version in the `dependencyManagement` section.
  - name changed to `${ant.project.name}-${version}-parent.pom`
* `all-pom`
  - is now `.build/cassandra-deps-template.xml`
  - contains dependencies (without version numbers) that will be included in the final package.
  - name changed to `${ant.project.name}-${version}.pom`
* `build-deps-pom`
  - is now `.build/cassandra-build-deps-template.xml`
  - contains dependencies required for the build only.  (i.e. not to be included in the final package)
  - name changed to `${ant.project.name}-${version}-deps.pom`


See https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Dependency_Management[the
Maven docs] on how to reference dependencies in the parent POM from the child
POMs.

For dependency versions that need to be available in `build.xml` and
`parent-pom-template`

 * specify the version as a property in `build.xml` in the form `<property name="thing.version" value="1.2.3"/>`.
 * add it to the `write-poms` target in the build.xml in the form `<filter token="thing.version" value="${thing.version}""/>`.
 * add the property to `parent-pom-template` in the form `<thing.version>@thing.verson@</thing.version>`.

=== Dependency management before Cassandra 4.2

Before Cassandra 4.2, dependencies were managed in `build.xml` and managed with
Maven Ant Tasks.

* Update dependencies in `build.xml`
** Add to `parent-pom` with correct version
** Add to `all-pom` if simple Cassandra dependency (see below)

Cassandra prior to version 4.2 uses the following pom files:

* *parent-pom* - contains all dependencies with the respective version.
All other poms will refer to the artifacts with specified versions
listed here.
* *build-deps-pom(-sources)* + *coverage-deps-pom* - used by `ant build`
compile target. Listed dependenices will be resolved and copied to
`build/lib/{jar,sources}` by executing the
`maven-ant-tasks-retrieve-build` target. This should contain libraries
that are required for build tools (grammar, docs, instrumentation), but
are not shipped as part of the Cassandra distribution.
* *test-deps-pom* - refered by `maven-ant-tasks-retrieve-test` to
retrieve and save dependencies to `build/test/lib`. Exclusively used
during JUnit test execution.
* *all-pom* - pom for
https://mvnrepository.com/artifact/org.apache.cassandra/cassandra-all[cassandra-all.jar]
that can be installed or deployed to public maven repos via
`ant publish`

=== Troubleshooting and conflict resolution

Here are some useful commands that may help you out resolving conflicts.

* `ant realclean` - gets rid of the build directory, including build
artifacts.
* `mvn dependency:tree -f build/apache-cassandra-*-SNAPSHOT.pom -Dverbose -Dincludes=org.slf4j`
- shows transitive dependency tree for artifacts, e.g. org.slf4j. In
case the command above fails due to a missing parent pom file, try
running `ant mvn-install`.
* `rm ~/.m2/repository/org/apache/cassandra/apache-cassandra/` - removes
cached local Cassandra maven artifacts
